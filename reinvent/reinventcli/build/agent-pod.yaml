apiVersion: v1
kind: Pod
metadata:
  name: agent-pod
spec:
  serviceAccountName: jenkins-pod
  containers:
    - name: builder
      image: 378255172879.dkr.ecr.eu-west-1.amazonaws.com/add-reinvent-builder:0.0.6
      resources:
        limits:
          cpu: 1000m
          memory: 1Gi
        requests:
          cpu: 1000m
          memory: 1Gi
      securityContext:
        privileged: true
      tty: true
      volumeMounts:
        - mountPath: /lib/modules
          name: modules
          readOnly: true
        - mountPath: /sys/fs/cgroup
          name: cgroup
        - mountPath: /var/lib/docker
          name: dind-storage
    - name: aws
      image: amazon/aws-cli:2.0.30
      command: ["sleep"]
      args: ["infinity"]
      resources:
        limits:
          cpu: 250m
          memory: 500Mi
        requests:
          cpu: 250m
          memory: 500Mi
    - name: singularity
      image: 378255172879.dkr.ecr.eu-west-1.amazonaws.com/quay.io/singularity/singularity:v3.7.4-slim
      command: ["sleep"]
      args: ["2h"]  # this image's sleep doesn't accept 'infinity'
      resources:
        limits:
          cpu: 1000m
          memory: 3Gi
        requests:
          cpu: 1000m
          memory: 3Gi
    - name: sonarqube-scanner
      image: 378255172879.dkr.ecr.eu-west-1.amazonaws.com/docker.io/sonarsource/sonar-scanner-cli:latest
      command: ["sleep"]
      args: ["infinity"]
      resources:
        limits:
          cpu: 250m
          memory: 2Gi
        requests:
          cpu: 150m
          memory: 2Gi
  volumes:
    - name: modules
      hostPath:
        path: /lib/modules
    - name: cgroup
      hostPath:
        path: /sys/fs/cgroup
    - name: dind-storage
      emptyDir: {}
